from dataclasses import dataclass


@dataclass
class Vulnerability:
 input:str
 vulnerability_type:str
 severity:str
 error_message:str


class VulnerabilityDetector:
 def analyze_result(self,result):
  if getattr(result,"escape_detected",False):
   return self._analyze_escape(result)
  return None
 def _analyze_escape(self,result):
  details=result.escape_details or "concurrency escaped test harness"
  is_timeout="timeout" in result.error.lower() if result.error else False
  escape_type="concurrent_escape_timeout" if is_timeout else "concurrent_escape"
  return Vulnerability(input=result.input_data,vulnerability_type=escape_type,severity="high",error_message=details)
 def categorize_results(self,results):
  if not results:
   return {"total_tests":0,"crashes":0,"successes":0,"timeouts":0,"escapes":0,"genuine_escapes":0,"vulnerabilities":[],"crash_rate":0}
  vulns=[]
  crashes=successes=timeouts=escapes=genuine_escapes=0
  for r in results:
   if r.crashed:
    crashes+=1
    if r.error and "timeout" in r.error.lower():
     timeouts+=1
   if r.success:
    successes+=1
   if getattr(r,"escape_detected",False):
    escapes+=1
    if not (r.error and "timeout" in r.error.lower()):
     genuine_escapes+=1
   v=self.analyze_result(r)
   if v:
    vulns.append(v)
  return {"total_tests":len(results),"crashes":crashes,"successes":successes,"timeouts":timeouts,"escapes":escapes,"genuine_escapes":genuine_escapes,"vulnerabilities":vulns,"crash_rate":crashes/len(results)}
